<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>라벨 편집기 Web (최종본)</title>
    <style>
        /* 사용자 지정 스타일 + 컴팩트 레이아웃 */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f0f0; margin: 0; padding: 15px; }
        .container { display: flex; gap: 15px; max-width: 1400px; margin: auto; }
        .panel { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .left-panel { flex: 2; }
        .right-panel { flex: 3; display: flex; flex-direction: column; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 0; margin-bottom: 15px; font-size: 1.3em; }
        .control-group { margin-bottom: 15px; }
        .control-group label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; }
        
        button, input { padding: 10px; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        
        .product-button { background-color: #f89797; cursor: pointer; border: 2px solid transparent; font-weight: bold; }
        .product-button.active { border-color: #007bff; background-color: #007bff; color: white; font-weight: bold; }
        
        #add-to-queue { width: 100%; background-color: #28a745; color: white; font-weight: bold; border: none; cursor: pointer; padding: 15px; }
        #generate-pdf { width: 100%; background-color: #007bff; color: white; font-weight: bold; border: none; cursor: pointer; }

        .radio-group { display: flex; border: 1px solid #ccc; border-radius: 5px; overflow: hidden; }
        .radio-group input { display: none; }
        .radio-group label { flex: 1; text-align: center; padding: 10px; background-color: #f8f9fa; cursor: pointer; font-size: 15px; }
        .radio-group input:checked + label { background-color: #007bff; color: white; }

        .input-group { display: flex; gap: 5px; align-items: center; }
        .input-group input, .input-group .date-display { flex-grow: 1; width: auto; }
        .input-group button { width: auto; padding: 10px; }

        #queue-list { list-style-type: none; padding: 0; min-height: 150px; max-height: 250px; overflow-y: auto; border: 1px solid #ccc; border-radius: 5px; margin-top: 10px; }
        #queue-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.9em;}
        .delete-item { background-color: #dc3545; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8em; }
        
        #preview-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; background-color: #e9ecef; border-radius: 5px; min-height: 280px; }
        #preview-image { max-width: 100%; max-height: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel panel">
            <h2>설정</h2>
            <div class="control-group">
                <label>1. 제품 선택</label>
                <div id="product-buttons" class="button-grid">
                    {% for product in products %}
                        <button class="product-button" data-product-name="{{ product }}">{{ product }}</button>
                    {% endfor %}
                </div>
            </div>
            <div class="control-group">
                <label>또는, 직접 입력</label>
                <div class="input-group">
                    <input type="text" id="custom-product-name" placeholder="제품명 직접 입력" style="width: 10%;">
                    <button id="set-custom-product">설정</button>
                </div>
            </div>
            <div class="control-group">
                <label>라벨 종류</label>
                <div id="paper-size-radios" class="radio-group"></div>
            </div>
            <div class="control-group">
                <label>원산지</label>
                <div id="origin-radios" class="radio-group"></div>
            </div>
            <div class="control-group">
                <label for="ingredient">원료</label>
                <input type="text" id="ingredient-input" value="닭고기">
            </div>
            <div class="control-group">
                <label>보관방법</label>
                <div class="radio-group">
                    <input type="radio" id="storage-refrigerated" name="storage" value="냉장" checked>
                    <label for="storage-refrigerated">냉장</label>
                    <input type="radio" id="storage-frozen" name="storage" value="냉동">
                    <label for="storage-frozen">냉동</label>
                </div>
            </div>
            <div class="control-group">
                <label>가공(포장)일</label>
                <div class="input-group">
                    <button id="date-down">-1일</button>
                    <span id="date-display" class="date-display" style="text-align: center; padding: 12px; border: 1px solid #ccc; border-radius: 5px;"></span>
                    <button id="date-up">+1일</button>
                </div>
            </div>
            <div class="control-group">
                <label for="weight">중량(Kg)</label>
                <div class="input-group">
                    <input type="number" id="weight" value="0.0" step="0.1">
                    <button id="weight-add-01" style="width: auto;">+0.1</button>
                    <button id="weight-add-1" style="width: auto;">+1</button>
                    <button id="weight-add-2" style="width: auto;">+2</button>
                    <button id="weight-reset" style="width: auto;">리셋</button>
                </div>
            </div>
            <button id="add-to-queue">⬇️ 대기열에 추가 <span id="queue-count">(0)</span></button>
        </div>

        <div class="right-panel panel">
            <h2>미리보기</h2>
            <div id="preview-area"><p>옵션을 선택하면 미리보기가 표시됩니다.</p></div>
            <h2 style="margin-top: 20px;">인쇄 대기열</h2>
            <ul id="queue-list"></ul>
            <button id="generate-pdf" style="margin-top: 10px;">인쇄하기</button>
        </div>
    </div>

    <script>
        // 전역 변수 및 설정
        let selectedProduct = null;
        let printQueue = [];
        let currentDate = new Date();
        const configData = {{ config_data|tojson|safe }};
        const originOptions = ["국내산", "중국산", "브라질", "미국산"];
        let previewTimeout;

        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            createOriginRadios();
            createPaperSizeRadios();
            updateDateDisplay();
            setupEventListeners();
        });

        // --- UI 생성 ---
        function createOriginRadios() {
            const originContainer = document.getElementById('origin-radios');
            originContainer.innerHTML = originOptions.map((option, index) => `
                <input type="radio" id="origin-${option}" name="origin" value="${option}" ${index === 0 ? 'checked' : ''}>
                <label for="origin-${option}">${option}</label>
            `).join('');
        }

        function createPaperSizeRadios() {
            const paperSizes = configData.paper_sizes || {};
            const paperContainer = document.getElementById('paper-size-radios');
            const paperOrder = ["일반 라벨 (3x2 인치)", "소형 라벨 (3x2 cm)"];
            
            paperContainer.innerHTML = '';
            paperOrder.forEach(name => {
                if (!paperSizes[name]) return;
                const id = `paper-${name.replace(/[\s\(\)]/g, '-')}`;
                const checked = name.includes("인치") ? 'checked' : '';
                paperContainer.innerHTML += `
                    <input type="radio" id="${id}" name="paper_size" value="${name}" ${checked}>
                    <label for="${id}">${name}</label>
                `;
            });
        }

        // --- 이벤트 리스너 설정 ---
        function setupEventListeners() {
            document.querySelectorAll('.product-button').forEach(b => b.addEventListener('click', () => handleProductSelect(b)));
            document.getElementById('set-custom-product').addEventListener('click', handleCustomProduct);
            document.querySelectorAll('input[name="origin"], input[name="storage"], input[name="paper_size"]').forEach(r => r.addEventListener('change', updatePreview));
            document.getElementById('ingredient-input').addEventListener('input', updatePreview);
            document.getElementById('date-down').addEventListener('click', () => adjustDate(-1));
            document.getElementById('date-up').addEventListener('click', () => adjustDate(1));
            document.getElementById('weight').addEventListener('input', updatePreview);
            document.getElementById('weight-add-01').addEventListener('click', () => adjustWeight(0.1));
            document.getElementById('weight-add-1').addEventListener('click', () => adjustWeight(1));
            document.getElementById('weight-add-2').addEventListener('click', () => adjustWeight(2));
            document.getElementById('weight-reset').addEventListener('click', resetWeight);
            document.getElementById('add-to-queue').addEventListener('click', handleAddToQueue);
            document.getElementById('generate-pdf').addEventListener('click', handleGeneratePdf);
        }
        
        // --- 이벤트 핸들러 ---
        function handleProductSelect(button) {
            document.querySelectorAll('.product-button.active').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
            selectedProduct = button.dataset.productName;
            document.getElementById('custom-product-name').value = '';

            const productInfo = configData.products[selectedProduct];
            if (productInfo) {
                if (productInfo.origin) {
                    const radio = document.querySelector(`input[name="origin"][value="${productInfo.origin}"]`);
                    if (radio) radio.checked = true;
                }
                document.getElementById('ingredient-input').value = productInfo.ingredient || '닭고기';
            } else {
                document.getElementById('ingredient-input').value = '닭고기';
            }
            updatePreview();
        }

        function handleCustomProduct() {
            const customName = document.getElementById('custom-product-name').value.trim();
            if (!customName) { alert('제품 이름을 입력해주세요.'); return; }
            document.querySelectorAll('.product-button.active').forEach(b => b.classList.remove('active'));
            selectedProduct = customName;
            updatePreview();
        }

        function handleAddToQueue() {
            if (!selectedProduct) { alert('먼저 제품을 선택해주세요.'); return; }
            const currentData = {
                name: selectedProduct,
                origin: document.querySelector('input[name="origin"]:checked').value,
                date: document.getElementById('date-display').textContent,
                weight: document.getElementById('weight').value,
                details: generateDetailsTextJS(
                    selectedProduct,
                    document.querySelector('input[name="storage"]:checked').value,
                    document.getElementById('ingredient-input').value
                )
            };
            printQueue.push(currentData);
            updateQueueList();
        }

        async function handleGeneratePdf() {
            if (printQueue.length === 0) {
                alert('인쇄 대기열에 항목이 없습니다.');
                return;
            }

            const selectedPaper = document.querySelector('input[name="paper_size"]:checked').value;
            const printButton = document.getElementById('generate-pdf');
            printButton.textContent = 'PDF 생성 중...';
            printButton.disabled = true;

            try {
                // 1. 서버에 PDF 데이터 요청
                const response = await fetch('/generate_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ queue: printQueue, paper_size: selectedPaper })
                });

                if (!response.ok) {
                    throw new Error('서버에서 PDF를 생성하는 데 실패했습니다.');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                // 2. 보이지 않는 iframe 생성하여 PDF 로드
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'position: absolute; width: 0; height: 0; border: 0;';
                iframe.src = url;

                // 3. iframe이 로드되면 인쇄 명령 실행
                iframe.onload = function() {
                    // PDF가 iframe 내부에 렌더링될 시간을 줌 (조금 더 안정적인 방법)
                    setTimeout(function() {
                        try {
                            iframe.contentWindow.focus();
                            // ★★★ 이 부분이 '프린터 선택' 창을 직접 호출합니다 ★★★
                            iframe.contentWindow.print();
                        } catch (e) {
                            alert("자동 인쇄를 시작할 수 없습니다. PDF를 새 탭에서 열어 직접 인쇄해주세요.");
                            window.open(url); // 실패 시 fallback
                        }
                    }, 500); // 0.5초의 넉넉한 딜레이
                };
                
                document.body.appendChild(iframe);

                // 사용자가 인쇄 작업을 마칠 시간을 예상하여, 넉넉하게 1분 뒤에 iframe 제거
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    window.URL.revokeObjectURL(url);
                }, 60000);

                printQueue = [];
                updateQueueList();

            } catch (error) {
                alert(`오류 발생: ${error.message}`);
            } finally {
                printButton.textContent = '인쇄하기';
                printButton.disabled = false;
            }
        }
        
        
        // --- UI 업데이트 및 데이터 처리 ---
        function updateDateDisplay() {
            const yyyy = currentDate.getFullYear();
            const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dd = String(currentDate.getDate()).padStart(2, '0');
            document.getElementById('date-display').textContent = `${yyyy}-${mm}-${dd}`;
        }

        function adjustDate(days) { currentDate.setDate(currentDate.getDate() + days); updateDateDisplay(); updatePreview(); }
        
        function adjustWeight(amount) {
            const weightInput = document.getElementById('weight');
            let currentWeight = parseFloat(weightInput.value) || 0.0;
            weightInput.value = (currentWeight + amount).toFixed(1);
            updatePreview();
        }

        function resetWeight() { document.getElementById('weight').value = "0.0"; updatePreview(); }
        
        function updateQueueList() {
            const listElement = document.getElementById('queue-list');
            listElement.innerHTML = '';
            printQueue.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>[${index+1}] ${item.name} / ${item.weight}Kg / ${item.origin}</span>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '삭제';
                deleteBtn.className = 'delete-item';
                deleteBtn.onclick = () => { printQueue.splice(index, 1); updateQueueList(); };
                li.appendChild(deleteBtn);
                listElement.appendChild(li);
            });
            document.getElementById('queue-count').textContent = `(${printQueue.length})`;
        }

        function generateDetailsTextJS(productName, storage, ingredient) {
            const productInfo = configData.products[productName] || {};
            let finalLines = [];
            let templateName = '';

            if (productInfo.template_type === 'standard_poultry') {
                templateName = (storage === '냉장') ? 'refrigerated_base' : 'frozen_base';
            } else if (productInfo.use_template) {
                templateName = productInfo.use_template;
            }

            if (templateName && configData.templates[templateName]) {
                finalLines = [...configData.templates[templateName]];
            } else if (productInfo.lines) {
                finalLines = [...productInfo.lines];
            } else { 
                templateName = (storage === '냉장') ? 'refrigerated_base' : 'frozen_base';
                finalLines = [...configData.templates[templateName]];
            }
            
            const ingredientLine = `*원료 및 함량: ${ingredient} 100%`;
            finalLines.unshift(ingredientLine);

            if (productInfo.replace_lines) {
                for (const [original, replacement] of Object.entries(productInfo.replace_lines)) {
                    const index = finalLines.indexOf(original);
                    if (index !== -1) finalLines[index] = replacement;
                }
            }
            if (productInfo.remove_lines) {
                finalLines = finalLines.filter(line => !productInfo.remove_lines.includes(line));
            }
            if (productInfo.append_lines) {
                finalLines.push(...productInfo.append_lines);
            }

            return finalLines.join('\n');
        }

        function updatePreview() {
            const productName = selectedProduct;
            if (!productName) return;
            
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(async () => {
                const previewArea = document.getElementById('preview-area');
                previewArea.innerHTML = '<p>미리보기 생성 중...</p>';
                
                const selectedPaper = document.querySelector('input[name="paper_size"]:checked').value;
                const labelData = {
                    name: productName,
                    origin: document.querySelector('input[name="origin"]:checked').value,
                    date: document.getElementById('date-display').textContent,
                    weight: document.getElementById('weight').value,
                    details: generateDetailsTextJS(
                        productName, 
                        document.querySelector('input[name="storage"]:checked').value,
                        document.getElementById('ingredient-input').value
                    )
                };

                const response = await fetch('/generate_preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label_data: labelData, paper_size: selectedPaper })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    previewArea.innerHTML = `<img id="preview-image" src="${url}" alt="라벨 미리보기">`;
                } else {
                    previewArea.innerHTML = '<p>미리보기 생성 실패</p>';
                }
            }, 200);
        }
        
        initialize();
    </script>
</body>
</html>